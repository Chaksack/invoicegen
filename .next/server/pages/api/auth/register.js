"use strict";(()=>{var e={};e.id=7,e.ids=[7],e.modules={8432:e=>{e.exports=require("bcryptjs")},9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},8210:e=>{e.exports=import("sequelize")},6249:(e,a)=>{Object.defineProperty(a,"l",{enumerable:!0,get:function(){return function e(a,t){return t in a?a[t]:"then"in a&&"function"==typeof a.then?a.then(a=>e(a,t)):"function"==typeof a&&"default"===t?a:void 0}}})},1333:(e,a,t)=>{t.a(e,async(e,s)=>{try{t.r(a),t.d(a,{config:()=>c,default:()=>u,routeModule:()=>d});var r=t(1802),n=t(7153),o=t(6249),i=t(3170),l=e([i]);i=(l.then?(await l)():l)[0];let u=(0,o.l)(i,"default"),c=(0,o.l)(i,"config"),d=new r.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/auth/register",pathname:"/api/auth/register",bundlePath:"",filename:""},userland:i});s()}catch(e){s(e)}})},3556:(e,a,t)=>{t.a(e,async(e,s)=>{try{t.d(a,{S3:()=>l,U:()=>d,YR:()=>c,sE:()=>u});var r=t(9344),n=t.n(r),o=t(6075),i=e([o]);o=(i.then?(await i)():i)[0];let l=(e,a,t=500)=>(console.error("API Error:",a),e.status(t).json({success:!1,message:a.message||"Server error",error:void 0})),u=(e,a,t="Success",s=200)=>e.status(s).json({success:!0,message:t,data:a}),c=async(e,a)=>{try{let t=e.headers.authorization;if(!t||!t.startsWith("Bearer "))return a.status(401).json({success:!1,message:"No token provided"});let s=t.split(" ")[1],r=n().verify(s,process.env.JWT_SECRET||"your_jwt_secret_key_change_this_in_production"),i=await o.n.findByPk(r.id);if(!i)return a.status(401).json({success:!1,message:"User not found"});return e.user=i,i}catch(e){return a.status(401).json({success:!1,message:"Invalid token"})}},d=async(e,a)=>!!e.user.emailVerified||a.status(403).json({success:!1,message:"Email verification required"});s()}catch(e){s(e)}})},409:(e,a,t)=>{t.a(e,async(e,s)=>{try{t.d(a,{Dv:()=>l,gk:()=>o});var r=t(8210),n=e([r]);let o=new(r=(n.then?(await n)():n)[0]).Sequelize(process.env.DB_NAME||"invoicegen",process.env.DB_USER||"postgres",process.env.DB_PASSWORD||"postgres",{host:process.env.DB_HOST||"localhost",port:parseInt(process.env.DB_PORT||"5432"),dialect:"postgres",logging:!1,dialectOptions:{ssl:{require:!0,rejectUnauthorized:!1}}}),i=async(e=5,a=5e3)=>{let t=0;for(;t<e;)try{return await o.authenticate(),console.log("Database connection has been established successfully."),!0}catch(s){if(t++,console.error(`Unable to connect to the database (attempt ${t}/${e}):`,s),t>=e)return console.error("Maximum connection attempts reached. Database connection failed."),console.error("CRITICAL: Database connection failed in production environment"),!1;console.log(`Retrying in ${a/1e3} seconds...`),await new Promise(e=>setTimeout(e,a))}return!1},l=async()=>{try{if(!await i())return console.error("Database connection failed after multiple retries"),!1;return t(1897),t(2198),await o.sync({alter:!1}),console.log("Database synchronized successfully."),!0}catch(e){return console.error("Error synchronizing database:",e),console.error("CRITICAL: Database synchronization failed in production environment"),!1}};s()}catch(e){s(e)}})},2198:(e,a,t)=>{t.a(e,async(e,s)=>{try{t.r(a),t.d(a,{default:()=>u});var r=t(8210),n=t(409),o=t(1897),i=e([r,n,o]);[r,n,o]=i.then?(await i)():i;let l=n.gk.define("Invoice",{id:{type:r.DataTypes.UUID,defaultValue:r.DataTypes.UUIDV4,primaryKey:!0},invoiceNumber:{type:r.DataTypes.STRING,allowNull:!0},invoiceDate:{type:r.DataTypes.DATEONLY,allowNull:!1,defaultValue:r.DataTypes.NOW},dueDate:{type:r.DataTypes.DATEONLY,allowNull:!0},logoUrl:{type:r.DataTypes.STRING,allowNull:!0},sender:{type:r.DataTypes.JSONB,allowNull:!1,defaultValue:{name:"",address:"",city:"",postalCode:"",country:""}},recipient:{type:r.DataTypes.JSONB,allowNull:!1,defaultValue:{name:"",address:"",city:"",postalCode:"",country:""}},items:{type:r.DataTypes.JSONB,allowNull:!1,defaultValue:[]},currency:{type:r.DataTypes.STRING,allowNull:!1,defaultValue:"USD"},taxRate:{type:r.DataTypes.FLOAT,allowNull:!1,defaultValue:0},subtotal:{type:r.DataTypes.FLOAT,allowNull:!1,defaultValue:0},total:{type:r.DataTypes.FLOAT,allowNull:!1,defaultValue:0},UserId:{type:r.DataTypes.UUID,allowNull:!1,references:{model:"Users",key:"id"}}},{timestamps:!0,hooks:{beforeCreate:e=>{let a=e.items.reduce((e,a)=>e+a.quantity*a.unitPrice,0),t=e.taxRate/100*a;e.subtotal=a,e.total=a+t},beforeUpdate:e=>{if(e.changed("items")||e.changed("taxRate")){let a=e.items.reduce((e,a)=>e+a.quantity*a.unitPrice,0),t=e.taxRate/100*a;e.subtotal=a,e.total=a+t}}}});o.default.hasMany(l),l.belongsTo(o.default);let u=l;s()}catch(e){s(e)}})},1897:(e,a,t)=>{t.a(e,async(e,s)=>{try{t.r(a),t.d(a,{default:()=>c});var r=t(8210),n=t(8432),o=t.n(n),i=t(409),l=e([r,i]);[r,i]=l.then?(await l)():l;let u=i.gk.define("User",{id:{type:r.DataTypes.UUID,defaultValue:r.DataTypes.UUIDV4,primaryKey:!0},email:{type:r.DataTypes.STRING,allowNull:!1,unique:!0,validate:{isEmail:!0}},password:{type:r.DataTypes.STRING,allowNull:!0},emailVerified:{type:r.DataTypes.BOOLEAN,defaultValue:!1},name:{type:r.DataTypes.STRING,allowNull:!0},image:{type:r.DataTypes.STRING,allowNull:!0},googleId:{type:r.DataTypes.STRING,allowNull:!0,unique:!0},settings:{type:r.DataTypes.JSONB,defaultValue:{sender:{name:"",address:"",city:"",postalCode:"",country:""},logoUrl:""}}},{timestamps:!0,hooks:{beforeCreate:async e=>{if(e.password){let a=await o().genSalt(10),t=await o().hash(e.password,a);e.password=t}},beforeUpdate:async e=>{if(e.changed("password")&&e.password){let a=await o().genSalt(10),t=await o().hash(e.password,a);e.password=t}}}});u.prototype.comparePassword=async function(e){return!!this.password&&await o().compare(e,this.password)};let c=u;s()}catch(e){s(e)}})},6075:(e,a,t)=>{t.a(e,async(e,s)=>{try{t.d(a,{m:()=>n.default,n:()=>r.default});var r=t(1897),n=t(2198),o=e([r,n]);[r,n]=o.then?(await o)():o,s()}catch(e){s(e)}})},3170:(e,a,t)=>{t.a(e,async(e,s)=>{try{t.r(a),t.d(a,{default:()=>c});var r=t(9344),n=t.n(r),o=t(3556),i=t(6075),l=t(409),u=e([o,i,l]);async function c(e,a){if("POST"!==e.method)return a.status(405).json({success:!1,message:"Method not allowed"});try{if(!await (0,l.Dv)())return a.status(500).json({success:!1,message:"Database connection failed. Please try again later."});let{email:t,password:s}=e.body;if(!t||!s)return a.status(400).json({success:!1,message:"Email and password are required"});if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t))return a.status(400).json({success:!1,message:"Invalid email format"});if(s.length<8)return a.status(400).json({success:!1,message:"Password must be at least 8 characters long"});if(await i.n.findOne({where:{email:t}}))return a.status(400).json({success:!1,message:"User with this email already exists"});let r=await i.n.create({email:t,password:s,emailVerified:!1,settings:{sender:{name:"",address:"",city:"",postalCode:"",country:""},logoUrl:""}}),u=n().sign({id:r.id},process.env.JWT_SECRET||"your_jwt_secret_key_change_this_in_production",{expiresIn:"24h"}),c=`http://localhost:3000/api/auth/verify-email?token=${u}`;console.log("Verification URL:",c);let d={id:r.id,email:r.email,emailVerified:r.emailVerified,settings:r.settings,createdAt:r.createdAt};return(0,o.sE)(a,d,"User registered successfully. Please check your email to verify your account.",201)}catch(e){if(console.error("Registration error:",e),e&&"object"==typeof e&&"name"in e){if("SequelizeConnectionError"===e.name||"SequelizeConnectionRefusedError"===e.name)return a.status(503).json({success:!1,message:"Database service unavailable. Please try again later."});if("SequelizeValidationError"===e.name&&"errors"in e&&Array.isArray(e.errors))return a.status(400).json({success:!1,message:"Validation error",errors:e.errors.map(e=>e.message)});if("SequelizeUniqueConstraintError"===e.name)return a.status(400).json({success:!1,message:"User with this email already exists"})}return(0,o.S3)(a,e)}}[o,i,l]=u.then?(await u)():u,s()}catch(e){s(e)}})},7153:(e,a)=>{var t;Object.defineProperty(a,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,a,t)=>{e.exports=t(145)}};var a=require("../../../webpack-api-runtime.js");a.C(e);var t=a(a.s=1333);module.exports=t})();